# Configuration Helm pour kube-prometheus-stack - VERSION CORRIGÉE
# Fichier : 06-helm-values-CORRECTED.yaml
# 
# Installation :
# helm install kube-prometheus-stack prometheus-community/kube-prometheus-stack \
#   --namespace monitoring \
#   --create-namespace \
#   --values 06-helm-values-CORRECTED.yaml

# ==============================================================================
# PROMETHEUS SERVER
# ==============================================================================
prometheus:
  prometheusSpec:
    # Rétention des données
    retention: 15d
    retentionSize: "18GB"
    
    # Ressources
    resources:
      requests:
        cpu: 500m
        memory: 2Gi
      limits:
        cpu: 2000m
        memory: 4Gi
    
    # Stockage persistant
    storageSpec:
      volumeClaimTemplate:
        spec:
          storageClassName: nfs-client
          accessModes:
            - ReadWriteOnce
          resources:
            requests:
              storage: 20Gi
    
    # Intervalles
    scrapeInterval: "30s"
    scrapeTimeout: "10s"
    evaluationInterval: "30s"
    
    # ✅ IMPORTANT : Laisser le chart gérer les sélecteurs automatiquement
    serviceMonitorSelector: {}
    serviceMonitorNamespaceSelector: {}
    podMonitorSelector: {}
    podMonitorNamespaceSelector: {}
    ruleSelector: {}
    ruleNamespaceSelector: {}

# ==============================================================================
# ALERTMANAGER
# ==============================================================================
alertmanager:
  alertmanagerSpec:
    # Ressources
    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        cpu: 200m
        memory: 256Mi
    
    # Stockage
    storage:
      volumeClaimTemplate:
        spec:
          storageClassName: nfs-client
          accessModes:
            - ReadWriteOnce
          resources:
            requests:
              storage: 10Gi
    
    retention: 120h

# ==============================================================================
# GRAFANA
# ==============================================================================
grafana:
  enabled: true
  
  # Mot de passe admin
  adminPassword: "admin"
  
  # Persistence
  persistence:
    enabled: true
    storageClassName: nfs-client
    accessModes:
      - ReadWriteOnce
    size: 10Gi
  
  # Ressources
  resources:
    requests:
      cpu: 250m
      memory: 512Mi
    limits:
      cpu: 500m
      memory: 1Gi
  
  # ✅ Configuration minimale qui fonctionne
  # Le chart configure automatiquement la datasource Prometheus
  
  # Dashboards pré-installés
  dashboards:
    default:
      # Kubernetes Cluster Monitoring
      kubernetes-cluster:
        gnetId: 7249
        revision: 1
        datasource: Prometheus
      
      # Node Exporter Full
      node-exporter:
        gnetId: 1860
        revision: 29
        datasource: Prometheus
      
      # Kubernetes Pod Resources
      k8s-resources:
        gnetId: 6417
        revision: 1
        datasource: Prometheus

# ==============================================================================
# COMPOSANTS
# ==============================================================================

# Node Exporter
nodeExporter:
  enabled: true

# Kube State Metrics
kubeStateMetrics:
  enabled: true

# Prometheus Operator
prometheusOperator:
  enabled: true

# ✅ Règles d'alerting par défaut (très important !)
defaultRules:
  create: true
  rules:
    alertmanager: true
    etcd: true
    configReloaders: true
    general: true
    k8s: true
    kubeApiserver: true
    kubeApiserverAvailability: true
    kubeApiserverSlos: true
    kubelet: true
    kubeProxy: true
    kubePrometheusGeneral: true
    kubePrometheusNodeRecording: true
    kubernetesApps: true
    kubernetesResources: true
    kubernetesStorage: true
    kubernetesSystem: true
    kubeSchedulerAlerting: true
    kubeSchedulerRecording: true
    kubeStateMetrics: true
    network: true
    node: true
    nodeExporterAlerting: true
    nodeExporterRecording: true
    prometheus: true
    prometheusOperator: true

# ✅ Monitoring des composants Kubernetes
kubeApiServer:
  enabled: true

kubelet:
  enabled: true
  
kubeControllerManager:
  enabled: true

coreDns:
  enabled: true

kubeEtcd:
  enabled: false  # Souvent false en environnement managé

kubeScheduler:
  enabled: true

kubeProxy:
  enabled: true
