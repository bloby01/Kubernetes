#!/bin/bash
# Script de commandes pour les exercices Grafana-Prometheus
# Formation Kubernetes - Chapitre 6

set -e

# Couleurs pour l'affichage
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

echo_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

echo_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# ==============================================================================
# EXERCICE 1 : Installation de kube-prometheus-stack
# ==============================================================================

exercice1_install() {
    echo_info "=== EXERCICE 1 : Installation de kube-prometheus-stack ==="
    
    # Étape 1 : Ajouter le repository Helm
    echo_info "Ajout du repository Helm prometheus-community..."
    helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
    
    # Étape 2 : Mise à jour des repos
    echo_info "Mise à jour du cache Helm..."
    helm repo update
    
    # Étape 3 : Créer le namespace
    echo_info "Création du namespace monitoring..."
    kubectl create namespace monitoring --dry-run=client -o yaml | kubectl apply -f -
    
    # Étape 4 : Installation du chart
    echo_info "Installation de kube-prometheus-stack..."
    helm install kube-prometheus-stack prometheus-community/kube-prometheus-stack \
      --namespace monitoring \
      --values manifests/06-helm-values.yaml \
      --wait \
      --timeout 10m
    
    echo_info "Installation terminée !"
}

exercice1_verify() {
    echo_info "=== Vérification de l'installation ==="
    
    # Vérifier les pods
    echo_info "Pods dans le namespace monitoring :"
    kubectl get pods -n monitoring
    
    echo ""
    echo_info "Services dans le namespace monitoring :"
    kubectl get svc -n monitoring
    
    echo ""
    echo_info "PVC (Persistent Volume Claims) :"
    kubectl get pvc -n monitoring
    
    echo ""
    echo_info "ServiceMonitors installés :"
    kubectl get servicemonitor -n monitoring
    
    echo ""
    echo_info "Attente que tous les pods soient Running..."
    kubectl wait --for=condition=Ready pods --all -n monitoring --timeout=300s
    
    echo_info "Installation vérifiée avec succès !"
}

exercice1_access_grafana() {
    echo_info "=== Accès à Grafana ==="
    
    # Récupérer le mot de passe admin
    GRAFANA_PASSWORD=$(kubectl get secret -n monitoring kube-prometheus-stack-grafana \
      -o jsonpath="{.data.admin-password}" | base64 --decode)
    
    echo_info "Mot de passe admin Grafana : ${GRAFANA_PASSWORD}"
    echo_info "Login : admin"
    echo ""
    echo_info "Démarrage du port-forward sur le port 3000..."
    echo_info "Accédez à Grafana : http://localhost:3000"
    echo_warn "Appuyez sur Ctrl+C pour arrêter"
    
    kubectl port-forward -n monitoring svc/kube-prometheus-stack-grafana 3000:80
}

exercice1_access_prometheus() {
    echo_info "=== Accès à Prometheus ==="
    echo_info "Démarrage du port-forward sur le port 9090..."
    echo_info "Accédez à Prometheus : http://localhost:9090"
    echo_warn "Appuyez sur Ctrl+C pour arrêter"
    
    kubectl port-forward -n monitoring svc/kube-prometheus-stack-prometheus 9090:9090
}

exercice1_access_alertmanager() {
    echo_info "=== Accès à Alertmanager ==="
    echo_info "Démarrage du port-forward sur le port 9093..."
    echo_info "Accédez à Alertmanager : http://localhost:9093"
    echo_warn "Appuyez sur Ctrl+C pour arrêter"
    
    kubectl port-forward -n monitoring svc/kube-prometheus-stack-alertmanager 9093:9093
}

# ==============================================================================
# EXERCICE 2 : Déployer une application avec métriques
# ==============================================================================

exercice2_deploy_app() {
    echo_info "=== EXERCICE 2 : Déploiement de l'application de démonstration ==="
    
    # Créer le namespace production
    echo_info "Création du namespace production..."
    kubectl apply -f manifests/01-namespaces.yaml
    
    # Déployer l'application
    echo_info "Déploiement de l'application demo-metrics..."
    kubectl apply -f manifests/02-demo-app-deployment.yaml
    
    # Attendre que les pods soient prêts
    echo_info "Attente que les pods soient Running..."
    kubectl wait --for=condition=Ready pods -l app=demo-metrics -n production --timeout=120s
    
    # Afficher les pods
    echo_info "Pods déployés :"
    kubectl get pods -n production
    
    echo_info "Application déployée avec succès !"
}

exercice2_test_metrics() {
    echo_info "=== Test de l'endpoint /metrics ==="
    
    # Port-forward vers l'application
    POD=$(kubectl get pods -n production -l app=demo-metrics -o jsonpath='{.items[0].metadata.name}')
    
    echo_info "Port-forward vers le pod ${POD}..."
    kubectl port-forward -n production ${POD} 8080:8080 &
    PF_PID=$!
    
    sleep 3
    
    echo_info "Test de l'endpoint /metrics :"
    curl -s http://localhost:8080/metrics | head -20
    
    # Arrêter le port-forward
    kill $PF_PID
    
    echo_info "Métriques accessibles !"
}

exercice2_create_servicemonitor() {
    echo_info "=== Création du ServiceMonitor ==="
    
    # Créer le ServiceMonitor
    echo_info "Application du ServiceMonitor..."
    kubectl apply -f manifests/03-servicemonitor.yaml
    
    # Vérifier
    echo_info "ServiceMonitor créé :"
    kubectl get servicemonitor -n monitoring demo-metrics-monitor -o yaml
    
    echo_info "ServiceMonitor créé avec succès !"
    echo_warn "Attendez 30 secondes que Prometheus découvre la target..."
    sleep 30
}

exercice2_verify_scraping() {
    echo_info "=== Vérification du scraping dans Prometheus ==="
    
    echo_info "Ouverture de Prometheus..."
    echo_info "1. Allez sur http://localhost:9090"
    echo_info "2. Cliquez sur Status > Targets"
    echo_info "3. Cherchez 'production/demo-metrics'"
    echo_info "4. Vérifiez que le statut est UP"
    echo ""
    echo_info "Requête PromQL de test :"
    echo "  rate(http_requests_total[5m])"
    
    kubectl port-forward -n monitoring svc/kube-prometheus-stack-prometheus 9090:9090
}

# ==============================================================================
# EXERCICE 3 : Créer des alertes
# ==============================================================================

exercice3_create_rules() {
    echo_info "=== EXERCICE 3 : Création des PrometheusRule ==="
    
    # Appliquer les règles
    echo_info "Application des règles Prometheus..."
    kubectl apply -f manifests/04-prometheus-rules.yaml
    
    # Vérifier
    echo_info "PrometheusRule créées :"
    kubectl get prometheusrule -n monitoring demo-app-rules
    
    echo_info "Règles créées avec succès !"
    echo_warn "Attendez 30 secondes que Prometheus recharge la configuration..."
    sleep 30
}

exercice3_verify_rules() {
    echo_info "=== Vérification des règles dans Prometheus ==="
    
    echo_info "Ouverture de Prometheus..."
    echo_info "1. Allez sur http://localhost:9090"
    echo_info "2. Cliquez sur Status > Rules"
    echo_info "3. Vérifiez que les groupes 'demo-app-recording-rules' et 'demo-app-alerting-rules' sont présents"
    echo ""
    echo_info "Pour voir les alertes :"
    echo_info "1. Cliquez sur Alerts"
    echo_info "2. Cherchez 'HighHTTPErrorRate', 'PodCrashLooping', etc."
    
    kubectl port-forward -n monitoring svc/kube-prometheus-stack-prometheus 9090:9090
}

exercice3_simulate_errors() {
    echo_info "=== Simulation d'erreurs pour déclencher une alerte ==="
    
    # Port-forward vers l'application
    POD=$(kubectl get pods -n production -l app=demo-metrics -o jsonpath='{.items[0].metadata.name}')
    
    echo_info "Port-forward vers ${POD}..."
    kubectl port-forward -n production ${POD} 8080:8080 &
    PF_PID=$!
    
    sleep 3
    
    echo_info "Génération de 1000 requêtes avec erreurs..."
    for i in {1..1000}; do
        curl -s http://localhost:8080/ > /dev/null
        # L'app génère des erreurs aléatoirement
    done
    
    kill $PF_PID
    
    echo_info "Requêtes envoyées !"
    echo_info "Attendez 5-10 minutes que l'alerte se déclenche..."
    echo_info "Vérifiez dans Prometheus > Alerts"
}

exercice3_configure_alertmanager() {
    echo_info "=== Configuration d'Alertmanager ==="
    
    echo_warn "ATTENTION : Éditez le fichier manifests/05-alertmanager-config.yaml"
    echo_warn "Remplacez YOUR/SLACK/WEBHOOK par votre webhook Slack réel"
    
    read -p "Avez-vous édité le fichier ? (y/n) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo_error "Configuration annulée"
        return 1
    fi
    
    # Appliquer la configuration
    echo_info "Application de la configuration Alertmanager..."
    kubectl apply -f manifests/05-alertmanager-config.yaml
    
    # Redémarrer Alertmanager
    echo_info "Redémarrage d'Alertmanager..."
    kubectl delete pod -n monitoring -l app.kubernetes.io/name=alertmanager
    
    echo_info "Configuration appliquée !"
}

# ==============================================================================
# EXERCICE 4 : Créer un dashboard Grafana personnalisé
# ==============================================================================

exercice4_create_dashboard() {
    echo_info "=== EXERCICE 4 : Création d'un dashboard Grafana ==="
    
    echo_info "Ouverture de Grafana..."
    echo_info "1. Connectez-vous à http://localhost:3000"
    echo_info "2. Allez dans Dashboards > New Dashboard"
    echo_info "3. Add visualization > Prometheus"
    echo_info ""
    echo_info "Requêtes PromQL suggérées :"
    echo ""
    echo "  # Taux de requêtes HTTP/s"
    echo "  sum(rate(http_requests_total[5m])) by (status)"
    echo ""
    echo "  # Latence P95"
    echo "  histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m]))"
    echo ""
    echo "  # Nombre de pods Running"
    echo "  count(kube_pod_status_phase{namespace='production',phase='Running'})"
    echo ""
    echo "  # Utilisation CPU par pod"
    echo "  sum(rate(container_cpu_usage_seconds_total{namespace='production'}[5m])) by (pod)"
    
    kubectl port-forward -n monitoring svc/kube-prometheus-stack-grafana 3000:80
}

# ==============================================================================
# NETTOYAGE
# ==============================================================================

cleanup() {
    echo_warn "=== Nettoyage des ressources ==="
    
    read -p "Êtes-vous sûr de vouloir tout supprimer ? (y/n) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo_info "Nettoyage annulé"
        return 0
    fi
    
    # Supprimer l'application
    echo_info "Suppression de l'application demo-metrics..."
    kubectl delete -f manifests/02-demo-app-deployment.yaml --ignore-not-found
    kubectl delete -f manifests/03-servicemonitor.yaml --ignore-not-found
    kubectl delete -f manifests/04-prometheus-rules.yaml --ignore-not-found
    
    # Désinstaller Helm
    echo_info "Désinstallation de kube-prometheus-stack..."
    helm uninstall kube-prometheus-stack -n monitoring
    
    # Supprimer les namespaces
    echo_info "Suppression des namespaces..."
    kubectl delete namespace production --ignore-not-found
    kubectl delete namespace monitoring --ignore-not-found
    
    # Supprimer les CRD
    echo_warn "Suppression des CRD Prometheus Operator..."
    kubectl delete crd \
      alertmanagerconfigs.monitoring.coreos.com \
      alertmanagers.monitoring.coreos.com \
      podmonitors.monitoring.coreos.com \
      probes.monitoring.coreos.com \
      prometheuses.monitoring.coreos.com \
      prometheusrules.monitoring.coreos.com \
      servicemonitors.monitoring.coreos.com \
      thanosrulers.monitoring.coreos.com \
      --ignore-not-found
    
    echo_info "Nettoyage terminé !"
}

# ==============================================================================
# MENU PRINCIPAL
# ==============================================================================

show_menu() {
    echo ""
    echo "======================================================================"
    echo "  Formation Kubernetes - Exercices Grafana & Prometheus"
    echo "======================================================================"
    echo ""
    echo "EXERCICE 1 : Installation"
    echo "  1) Installer kube-prometheus-stack"
    echo "  2) Vérifier l'installation"
    echo "  3) Accéder à Grafana"
    echo "  4) Accéder à Prometheus"
    echo "  5) Accéder à Alertmanager"
    echo ""
    echo "EXERCICE 2 : Application avec métriques"
    echo "  6) Déployer l'application demo"
    echo "  7) Tester l'endpoint /metrics"
    echo "  8) Créer le ServiceMonitor"
    echo "  9) Vérifier le scraping"
    echo ""
    echo "EXERCICE 3 : Alerting"
    echo "  10) Créer les PrometheusRule"
    echo "  11) Vérifier les règles"
    echo "  12) Simuler des erreurs"
    echo "  13) Configurer Alertmanager"
    echo ""
    echo "EXERCICE 4 : Dashboard Grafana"
    echo "  14) Créer un dashboard personnalisé"
    echo ""
    echo "AUTRES"
    echo "  98) Tout exécuter automatiquement"
    echo "  99) Nettoyage complet"
    echo "  0) Quitter"
    echo ""
    echo -n "Votre choix : "
}

# Boucle principale
while true; do
    show_menu
    read choice
    
    case $choice in
        1) exercice1_install ;;
        2) exercice1_verify ;;
        3) exercice1_access_grafana ;;
        4) exercice1_access_prometheus ;;
        5) exercice1_access_alertmanager ;;
        6) exercice2_deploy_app ;;
        7) exercice2_test_metrics ;;
        8) exercice2_create_servicemonitor ;;
        9) exercice2_verify_scraping ;;
        10) exercice3_create_rules ;;
        11) exercice3_verify_rules ;;
        12) exercice3_simulate_errors ;;
        13) exercice3_configure_alertmanager ;;
        14) exercice4_create_dashboard ;;
        98)
            exercice1_install
            exercice1_verify
            exercice2_deploy_app
            exercice2_create_servicemonitor
            exercice3_create_rules
            echo_info "Installation automatique terminée !"
            ;;
        99) cleanup ;;
        0) echo_info "Au revoir !"; exit 0 ;;
        *) echo_error "Choix invalide" ;;
    esac
    
    echo ""
    read -p "Appuyez sur Entrée pour continuer..."
done
